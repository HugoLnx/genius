<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
  </head>
  <body>
    <script type="text/javascript" src="src/namespaces.js"></script>
    <script type="text/javascript" src="src/genius/HappyArray.js"></script>
    <script type="text/javascript" src="src/genius/Color.js"></script>
    <script type="text/javascript" src="src/genius/Stage.js"></script>
    <script type="text/javascript" src="src/genius/Game.js"></script>

    <script>
      (function(Genius) {
        function Button(normalColor, highlightColor, sound, board) {
          var _normalColor = normalColor;
          var _highlightColor = highlightColor;
          var _element = newDiv(board);
          var _sound = sound;

          this.highlight = function() {
            _element.style.backgroundColor = _highlightColor;
            _sound.play();
          };

          this.undoHighlight = function() {
            _element.style.backgroundColor = _normalColor;
          };

          function newDiv(board) {
            var div = document.createElement("div")
            div.style.width = "100px";
            div.style.height = "100px";
            div.style.display = "inline-block";
            div.style.backgroundColor = _normalColor;
            board.appendChild(div);
            return div;
          }

          this.element = function() {
            return _element;
          };
        }

        function Board() {
          var _btns = {};
          var _element = createDiv();

          this.btnOfCode = function(code) {
            var all = [
              _btns.green,
              _btns.yellow,
              _btns.blue,
              _btns.red
            ];

            return all[code];
          };

          this.eachButton = function(whatToDo) {
            var all = [
              _btns.green,
              _btns.yellow,
              _btns.blue,
              _btns.red
            ];

            for(var i = 0; i<all.length; i++) {
              var btn = all[i];
              whatToDo(i, btn);
            }
          };

          this.btns = function() {
            return _btns;
          };

          function createDiv() {
            var div = document.createElement("div");
            div.style.width = "200px";
            div.style.height = "200px";
            document.body.appendChild(div);

            _btns = {
              green: new Button("#050", "green", new Audio("sound/pi.wav"), div),
              yellow: new Button("#550", "yellow", new Audio("sound/pi2.wav"), div),
              blue: new Button("#005", "blue", new Audio("sound/pi3.wav"), div),
              red: new Button("#500", "red", new Audio("sound/pi4.wav"), div)
            }

            return div;
          }
        }

        function HUD() {
          var _level = newP();

          this.level = function(level) {
            _level.textContent = "Level: " + level;
          };

          function newP() {
            var p = document.createElement("p");
            document.body.appendChild(p)
            return p;
          }
        }

        function Controls(board) {
          var _board = board;

          this.enable = function() {
            _board.eachButton(function(code, btn){
              btn.element().onclick = function() {
                var hitted = stage.hit(Genius.Color.ofCode(code));
                if (hitted) {
                  highlightButton(btn, function() {
                    if(stage.passed()) {
                      stage = game.nextStage();
                      hud.level(stage.level());
                      disable();
                      setTimeout(function(){
                        highlightNext();
                      }, 500);
                    }
                  });
                } else {
                  document.write("<h1>YOU LOSE</h1>");
                }
              }
            });
          };

          function disable() {
            _board.eachButton(function(code, btn){
              btn.element().onclick = function(){};
            });
          };

        }

        var game = new Genius.Game();
        var hud = new HUD();
        var board = new Board();
        var stage = game.nextStage();
        var controls = new Controls(board);
        hud.level(stage.level());

        function highlightNext() {
          var color = stage.nextColor();
          var btn = board.btnOfCode(color.code());
          btn.highlight();

          setTimeout(function() {
            btn.undoHighlight();

            if(stage.allShown()) {
              controls.enable();
            } else {
              setTimeout(highlightNext, 250);
            }
          }, 1000);
        };
        highlightNext();

        function highlightButton(btn, after) {
          btn.highlight();
          setTimeout(function() {
            btn.undoHighlight();
            setTimeout(function() {
              after();
            }, 150);
          }, 100);
        }

      }(HugoLnx.Genius));
    </script>
  </body>
</html>

